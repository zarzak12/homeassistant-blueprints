blueprint:
  name: Zendure - Charge Progressive Tempo + Solaire
  description: >
    Charge progressive de la batterie Zendure en Heures Creuses
    selon le niveau de batterie, la couleur Tempo et la prÃ©vision solaire du lendemain,
    avec limitation automatique pour ne pas dÃ©passer la puissance souscrite du compteur.
  domain: automation

  input:
    tempo_sensor:
      name: Capteur Tempo
      description: Couleur Tempo du lendemain (Bleu / Blanc / Rouge)
      selector:
        entity:
          domain: sensor

    battery_level_sensor:
      name: Niveau de batterie
      description: Niveau de charge de la batterie (%)
      selector:
        entity:
          domain: sensor

    solar_forecast_sensor:
      name: PrÃ©vision solaire demain
      description: Ã‰nergie solaire prÃ©vue demain (kWh)
      selector:
        entity:
          domain: sensor

    house_power_sensor:
      name: Consommation instantanÃ©e maison
      description: Puissance actuellement tirÃ©e sur le rÃ©seau (W)
      selector:
        entity:
          domain: sensor

    contract_power:
      name: Puissance souscrite compteur
      description: Puissance maximale autorisÃ©e par le contrat (kVA)
      default: 7
      selector:
        number:
          min: 3
          max: 36
          step: 1
          unit_of_measurement: "kVA"

    zendure_manager:
      name: Zendure Manager
      description: EntitÃ© de contrÃ´le du Zendure Manager
      selector:
        entity:
          domain: select

    input_limit:
      name: Limite d'entrÃ©e
      description: EntitÃ© pour dÃ©finir la puissance de charge rÃ©seau
      selector:
        entity:
          domain: number

    ac_mode:
      name: Mode AC
      description: EntitÃ© pour dÃ©finir le mode AC
      selector:
        entity:
          domain: select

    charge_time:
      name: Heure de dÃ©clenchement
      default: "22:00:00"
      selector:
        time:

    low_battery_threshold:
      name: Seuil batterie faible
      default: 30
      selector:
        number:
          min: 0
          max: 100
          unit_of_measurement: "%"

    medium_battery_threshold:
      name: Seuil batterie moyenne
      default: 60
      selector:
        number:
          min: 0
          max: 100
          unit_of_measurement: "%"

    solar_medium_threshold:
      name: Seuil solaire moyen
      default: 3.5
      selector:
        number:
          min: 0
          max: 50
          step: 0.1
          unit_of_measurement: "kWh"

    solar_good_threshold:
      name: Seuil solaire Ã©levÃ©
      default: 7
      selector:
        number:
          min: 0
          max: 50
          step: 0.1
          unit_of_measurement: "kWh"

    high_power_limit:
      name: Puissance charge rapide
      default: 1700
      selector:
        number:
          min: 0
          max: 2400
          unit_of_measurement: "W"

    medium_power_limit:
      name: Puissance charge normale
      default: 1200
      selector:
        number:
          min: 0
          max: 2400
          unit_of_measurement: "W"

    low_power_limit:
      name: Puissance charge douce
      default: 600
      selector:
        number:
          min: 0
          max: 2400
          unit_of_measurement: "W"

trigger:
  - platform: time
    at: !input charge_time

condition:
  - condition: or
    conditions:
      - condition: state
        entity_id: !input tempo_sensor
        state: "Blanc"
      - condition: state
        entity_id: !input tempo_sensor
        state: "Rouge"

action:
  # SÃ©curitÃ© : on coupe avant dÃ©cision
  - action: select.select_option
    target:
      entity_id: !input zendure_manager
    data:
      option: "off"

  - choose:
      # â˜€ï¸ Soleil Ã©levÃ© â†’ pas de charge rÃ©seau
      - conditions:
          - condition: numeric_state
            entity_id: !input solar_forecast_sensor
            above: !input solar_good_threshold
        sequence:
          - action: select.select_option
            target:
              entity_id: !input zendure_manager
            data:
              option: "off"

      # ðŸŒ¤ï¸ Soleil moyen â†’ charge douce limitÃ©e compteur
      - conditions:
          - condition: numeric_state
            entity_id: !input solar_forecast_sensor
            above: !input solar_medium_threshold
            below: !input solar_good_threshold
        sequence:
          - action: number.set_value
            target:
              entity_id: !input input_limit
            data:
              value: >
                {{
                    [
                      (contract_power | float(0) * 1000)
                      - states(house_power_sensor) | float(0),
                      low_power_limit | float(0),
                      0
                    ] | sort | nth(1) | round(0)
                  }}

          - action: select.select_option
            target:
              entity_id: !input ac_mode
            data:
              option: "input"

      # ðŸŒ§ï¸ Peu de soleil â†’ charge selon batterie + compteur
      - conditions:
          - condition: numeric_state
            entity_id: !input solar_forecast_sensor
            below: !input solar_medium_threshold
        sequence:
          - choose:
              - conditions:
                  - condition: numeric_state
                    entity_id: !input battery_level_sensor
                    below: !input low_battery_threshold
                sequence:
                  - action: number.set_value
                    target:
                      entity_id: !input input_limit
                    data:
                      value: >
                        {{ [
                          (contract_power | float(0) * 1000)
                          - states(house_power_sensor) | float(0),
                          high_power_limit | float(0),
                          0
                        ] | sort | nth(1) | round(0) }}

              - conditions:
                  - condition: numeric_state
                    entity_id: !input battery_level_sensor
                    below: !input medium_battery_threshold
                sequence:
                  - action: number.set_value
                    target:
                      entity_id: !input input_limit
                    data:
                      value: >
                        {{ [
                          (contract_power | float(0) * 1000)
                          - states(house_power_sensor) | float(0),
                          medium_power_limit | float(0),
                          0
                        ] | sort | nth(1) | round(0) }}

              - conditions:
                  - condition: numeric_state
                    entity_id: !input battery_level_sensor
                    above: !input medium_battery_threshold
                sequence:
                  - action: number.set_value
                    target:
                      entity_id: !input input_limit
                    data:
                      value: >
                        {{ [
                          (contract_power | float(0) * 1000)
                          - states(house_power_sensor) | float(0),
                          low_power_limit | float(0),
                          0
                        ] | sort | nth(1) | round(0) }}

          - action: select.select_option
            target:
              entity_id: !input ac_mode
            data:
              option: "input"

mode: single
